# getAction RPC Cost Time 分析（fastbot.log vs fastbot2.log）

基于 **fastbot.log** 与 **fastbot2.log** 中 `rpc cost time` 的统计，分析 C++ 侧 getAction/getActionFromBuffer 的耗时。

---

## 一、样本范围

| Log 文件 | 样本数 | 说明 |
|----------|--------|------|
| **fastbot.log** | 1,771 条 | binary 路径（先 binary，失败回退 XML） |
| **fastbot2.log** | 730 条 | XML 路径（treeDumpMode=xml，仅 dumpXml） |

**rpc cost time** 包含：
- JNI 传输（binary buffer 或 XML string）
- C++ 解析（createFromBinary 或 createFromXml）
- Model::getAction（RL 模型推理）

---

## 二、fastbot.log（binary 路径）

### 2.1 基本统计

| 指标 | 数值 |
|------|------|
| **样本数** | 1,771 条 |
| **总和** | 1,175 ms |
| **平均值** | **0.66 ms** |
| **最小值** | 0 ms |
| **最大值** | **12 ms** |
| **P50（中位数）** | 0 ms |
| **P90** | 2 ms |
| **P95** | 2 ms |
| **P99** | 5 ms |

### 2.2 分布

| 耗时 | 出现次数 | 占比 |
|------|----------|------|
| **0 ms** | 1,040 | **58.7%** |
| **1 ms** | 487 | 27.5% |
| **2 ms** | 161 | 9.1% |
| **3 ms** | 40 | 2.3% |
| **4 ms** | 15 | 0.8% |
| **≥5 ms** | 28 | 1.6% |

结论：**约 59% 的 event 在 0 ms**（< 1 ms），**95% 在 ≤2 ms**，极值 12 ms。

---

## 三、fastbot2.log（XML 路径）

### 3.1 基本统计

| 指标 | 数值 |
|------|------|
| **样本数** | 730 条 |
| **总和** | 799 ms |
| **平均值** | **1.09 ms** |
| **最小值** | 0 ms |
| **最大值** | **8 ms** |
| **P50（中位数）** | 1 ms |
| **P90** | 2 ms |
| **P95** | 3 ms |
| **P99** | 5 ms |

### 3.2 分布

| 耗时 | 出现次数 | 占比 |
|------|----------|------|
| **0 ms** | 184 | **25.2%** |
| **1 ms** | 381 | **52.2%** |
| **2 ms** | 114 | 15.6% |
| **3 ms** | 31 | 4.2% |
| **4 ms** | 11 | 1.5% |
| **≥5 ms** | 9 | 1.2% |

结论：**约 25% 在 0 ms，52% 在 1 ms**，**95% 在 ≤3 ms**，极值 8 ms。

---

## 四、对比分析

### 4.1 基本指标对比

| 指标 | fastbot.log（binary） | fastbot2.log（XML） | 差异 |
|------|----------------------|---------------------|------|
| **平均值** | 0.66 ms | 1.09 ms | XML 慢 **1.65x** |
| **中位数** | 0 ms | 1 ms | XML 慢（0→1 ms） |
| **最大值** | 12 ms | 8 ms | binary 极值更高 |
| **P90** | 2 ms | 2 ms | 相同 |
| **P95** | 2 ms | 3 ms | XML 略慢 |
| **P99** | 5 ms | 5 ms | 相同 |

### 4.2 分布对比

| 耗时 | fastbot.log（binary） | fastbot2.log（XML） | 差异 |
|------|----------------------|---------------------|------|
| **0 ms** | 58.7% | 25.2% | binary 多 **33.5%** |
| **1 ms** | 27.5% | 52.2% | XML 多 **24.7%** |
| **≤2 ms** | 95.3% | 93.0% | 相近 |
| **≤3 ms** | 97.6% | 97.2% | 相近 |

### 4.3 关键发现

1. **平均值差异**：XML 路径平均慢 **1.65x**（0.66 ms → 1.09 ms），但绝对值很小（< 0.5 ms）
2. **0 ms 占比**：binary 路径 0 ms 占比高（58.7% vs 25.2%），说明 binary 解析更快
3. **长尾差异**：binary 路径极值更高（12 ms vs 8 ms），但 P99 相同（5 ms）
4. **整体性能**：**两种路径的 rpc cost time 都很小**（< 2 ms 占 95%），**不是瓶颈**

---

## 五、与 Java 侧序列化对比

| 阶段 | fastbot.log（binary） | fastbot2.log（XML） |
|------|----------------------|---------------------|
| **Java 序列化** | dumpBinary: 413 ms | dumpXml: 291 ms |
| **C++ 解析 + RPC** | rpc cost: 0.66 ms | rpc cost: 1.09 ms |
| **Java/C++ 比例** | **625:1** | **267:1** |

**结论**：
- **Java 侧序列化占绝对主导**（>99.8%）
- C++ 侧差异（0.66 ms vs 1.09 ms）**可忽略**（< 0.5 ms）
- 即使 binary 路径 C++ 更快，整体仍慢于 XML（Java 侧 dumpBinary 413 ms > dumpXml 291 ms）

---

## 六、结论

### 6.1 C++ 侧性能

1. **binary 路径 C++ 侧更快**：平均 0.66 ms vs 1.09 ms（快 1.65x），0 ms 占比高（58.7% vs 25.2%）
2. **差异很小**：绝对值 < 0.5 ms，在整体 event time（> 100 ms）中可忽略
3. **两种路径都很快**：95% 在 ≤2–3 ms，不是瓶颈

### 6.2 整体性能（Java + C++）

| 路径 | Java 序列化 | C++ RPC | 总计 | 结论 |
|------|------------|---------|------|------|
| **binary** | 413 ms | 0.66 ms | **~414 ms** | 慢 |
| **XML** | 291 ms | 1.09 ms | **~292 ms** | **快** |

**结论**：虽然 C++ 侧 binary 更快，但 **Java 侧序列化占主导**（>99.8%），且 dumpXml 在 Java 侧更快，导致 **整体 XML 路径更快**（约 1.4x）。

### 6.3 优化建议

1. **C++ 侧无需优化**：rpc cost time 已足够小（< 2 ms），不是瓶颈
2. **Java 侧是重点**：dumpBinary（413 ms）vs dumpXml（291 ms）是主要差异来源
3. **当前策略合理**：binary 优先 + XML 回退，在 binary 成功时利用 C++ 侧优势，失败时回退到 XML（Java 侧更快）

---

## 七、附录：分布直方图

### fastbot.log（binary）
```
0ms: ████████████████████████████████████████████████████████████████ (58.7%)
1ms: ████████████████████████████████████ (27.5%)
2ms: ████████████ (9.1%)
3ms: ███ (2.3%)
≥4ms: ██ (2.4%)
```

### fastbot2.log（XML）
```
0ms: ████████████████████████ (25.2%)
1ms: ████████████████████████████████████████████████████████████████ (52.2%)
2ms: ████████████████ (15.6%)
3ms: ██████ (4.2%)
≥4ms: ██ (2.7%)
```
